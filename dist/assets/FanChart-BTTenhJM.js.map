{"version":3,"file":"FanChart-BTTenhJM.js","sources":["../../src/components/FanChart.tsx"],"sourcesContent":["\"use client\";\r\n\r\nimport React from \"react\";\r\nimport { Line } from \"react-chartjs-2\";\r\nimport {\r\n  Chart as ChartJS,\r\n  LineController,\r\n  LineElement,\r\n  PointElement,\r\n  LinearScale,\r\n  CategoryScale,\r\n  Tooltip,\r\n  Filler,\r\n  type ChartOptions,\r\n} from \"chart.js\";\r\nimport { getRelativePosition } from \"chart.js/helpers\";\r\nimport { GOLD } from \"@/theme/chartTheme\";\r\n\r\nChartJS.register(LineController, LineElement, PointElement, LinearScale, CategoryScale, Tooltip, Filler);\r\n\r\ntype MCArtifact = {\r\n  symbol: string;\r\n  horizon_days: number;\r\n  median_path: [number, number][];\r\n  bands: {\r\n    p50: [number, number][];\r\n    p80_low: [number, number][];\r\n    p80_high: [number, number][];\r\n    p95_low: [number, number][];\r\n    p95_high: [number, number][];\r\n  };\r\n};\r\n\r\nconst GOLD_GLOW = \"rgba(203,161,53,0.28)\"; // soft halo\r\nconst BAND80 = \"rgba(203,161,53,0.12)\";     // gold-tinted action band\r\nconst BAND95 = \"rgba(255,255,255,0.07)\";    // neutral uncertainty\r\n\r\ntype FanProps = { data?: MCArtifact; artifact?: MCArtifact };\r\n\r\nexport default function FanChart({ data, artifact }: FanProps) {\r\n  const a = (data ?? artifact) as MCArtifact | undefined;\r\n  if (!a || !Array.isArray(a.median_path) || !a.median_path.length || !a.bands) {\r\n    return <div className=\"text-xs opacity-70\">Run a simulation to view.</div>;\r\n  }\r\n\r\n  const { symbol, horizon_days, median_path, bands } = a;\r\n\r\n  const labels = median_path.map(([i]) => `D${i}`);\r\n  const yMedian = median_path.map(([, v]) => v);\r\n  const y80Low = bands.p80_low.map(([, v]) => v);\r\n  const y80High = bands.p80_high.map(([, v]) => v);\r\n  const y95Low = bands.p95_low.map(([, v]) => v);\r\n  const y95High = bands.p95_high.map(([, v]) => v);\r\n\r\n  const [hoverIdx, setHoverIdx] = React.useState<number | null>(null);\r\n  const [hoverBand, setHoverBand] = React.useState<\"p80\" | \"p95\" | null>(null);\r\n  const chartRef = React.useRef<ChartJS<\"line\"> | null>(null);\r\n  const clamp = (v: number, lo: number, hi: number) => Math.max(lo, Math.min(hi, v));\r\n\r\n  // Datasets: back-to-front fill order. Duplicate median for glow.\r\n  const chartData = {\r\n    labels,\r\n    datasets: [\r\n      {\r\n        label: \"95% band\",\r\n        data: y95High,\r\n        borderWidth: 0,\r\n        backgroundColor: BAND95,\r\n        fill: { target: 2, above: BAND95, below: BAND95 },\r\n        pointRadius: 0,\r\n      },\r\n      {\r\n        label: \"80% band\",\r\n        data: y80High,\r\n        borderWidth: 0,\r\n        backgroundColor: BAND80,\r\n        fill: { target: 3, above: BAND80, below: BAND80 },\r\n        pointRadius: 0,\r\n      },\r\n      { label: \"_95_low\", data: y95Low, borderWidth: 0, pointRadius: 0 },\r\n      { label: \"_80_low\", data: y80Low, borderWidth: 0, pointRadius: 0 },\r\n\r\n      // Gold glow (thick, translucent)\r\n      {\r\n        label: \"MedianGlow\",\r\n        data: yMedian,\r\n        borderColor: GOLD_GLOW,\r\n        borderWidth: 6,\r\n        pointRadius: 0,\r\n        tension: 0.16,\r\n      },\r\n      // Crisp gold median\r\n      {\r\n        label: \"Median\",\r\n        data: yMedian,\r\n        borderColor: GOLD,\r\n        borderWidth: 2,\r\n        pointRadius: 0,\r\n        tension: 0.16,\r\n      },\r\n    ],\r\n  };\r\n\r\n  const options: ChartOptions<\"line\"> = {\r\n    responsive: true,\r\n    maintainAspectRatio: false,\r\n    interaction: { mode: \"index\", intersect: false },\r\n    plugins: { legend: { display: false }, tooltip: { enabled: true } },\r\n    scales: {\r\n      x: {\r\n        grid: { display: false },\r\n        ticks: { maxRotation: 0 },\r\n        title: { display: true, text: \"Days\", color: \"#C7C9D1\" },\r\n      },\r\n      y: { title: { display: true, text: \"Price\", color: \"#C7C9D1\" } },\r\n    },\r\n    // @ts-ignore\r\n    onHover: (e, _els, chart) => {\r\n      const scales: any = (chart as any).scales;\r\n      const x = scales?.x, y = scales?.y;\r\n      if (!x || !y) return;\r\n      const pos = getRelativePosition((e as any).native ?? e, chart as any);\r\n      const xVal = x.getValueForPixel(pos.x);\r\n      const yVal = y.getValueForPixel(pos.y);\r\n      if (xVal == null || yVal == null || !Number.isFinite(xVal) || !Number.isFinite(yVal)) {\r\n        setHoverIdx(null); setHoverBand(null); return;\r\n      }\r\n      const idx = clamp(Math.round(Number(xVal)), 0, labels.length - 1);\r\n      const y80L = y80Low[idx], y80H = y80High[idx], y95L = y95Low[idx], y95H = y95High[idx];\r\n\r\n      let band: \"p80\" | \"p95\" | null = null;\r\n      if (y80L != null && y80H != null && yVal >= y80L && yVal <= y80H) band = \"p80\";\r\n      else if (y95L != null && y95H != null && yVal >= y95L && yVal <= y95H) band = \"p95\";\r\n\r\n      setHoverIdx(idx); setHoverBand(band);\r\n      const canvas = (chart as any).canvas as HTMLCanvasElement;\r\n      if (canvas) canvas.style.cursor = \"crosshair\";\r\n    },\r\n  };\r\n\r\n  // Overlay crosshair + band tag (gold outline when on 80%)\r\n  const hoverPlugin = {\r\n    id: \"fanHoverOverlay\",\r\n    afterDraw: (chart: any) => {\r\n      if (hoverIdx == null) return;\r\n      const { ctx, chartArea, scales } = chart;\r\n      const x = scales?.x, y = scales?.y;\r\n      if (!x || !y) return;\r\n\r\n      const xPix = x.getPixelForValue(hoverIdx);\r\n      ctx.save();\r\n      ctx.strokeStyle = \"rgba(148,163,184,0.45)\";\r\n      ctx.lineWidth = 1;\r\n      ctx.beginPath();\r\n      ctx.moveTo(xPix, chartArea.top);\r\n      ctx.lineTo(xPix, chartArea.bottom);\r\n      ctx.stroke();\r\n\r\n      if (hoverBand) {\r\n        const tag = hoverBand === \"p80\" ? \"80% band\" : \"95% band\";\r\n        const pad = 6;\r\n        const textX = Math.min(Math.max(xPix + 8, chartArea.left + 4), chartArea.right - 104);\r\n        const textY = chartArea.top + 8;\r\n        ctx.font = \"12px ui-sans-serif, system-ui, -apple-system\";\r\n        ctx.fillStyle = \"rgba(0,0,0,0.92)\";\r\n        const w = ctx.measureText(tag).width + pad * 2;\r\n        ctx.fillRect(textX, textY, w, 18);\r\n        ctx.strokeStyle = hoverBand === \"p80\" ? GOLD : \"rgba(255,255,255,0.28)\";\r\n        ctx.strokeRect(textX, textY, w, 18);\r\n        ctx.fillStyle = \"#E5E7EB\";\r\n        ctx.fillText(tag, textX + pad, textY + 13);\r\n      }\r\n      ctx.restore();\r\n    },\r\n  };\r\n\r\n  React.useEffect(() => {\r\n    const c = chartRef.current?.canvas as HTMLCanvasElement | undefined | null;\r\n    if (!c) return;\r\n    const onLeave = () => { setHoverIdx(null); setHoverBand(null); c.style.cursor = \"default\"; };\r\n    c.addEventListener(\"mouseleave\", onLeave);\r\n    return () => c.removeEventListener(\"mouseleave\", onLeave);\r\n  }, []);\r\n\r\n  return (\r\n    <div data-chart=\"fan\" className=\"relative w-full overflow-hidden\" style={{ height: 360 }}>\r\n      <Line\r\n        ref={chartRef}\r\n        data={chartData}\r\n        options={options}\r\n        plugins={[hoverPlugin]}\r\n        role=\"img\"\r\n        aria-label={`Fan chart for ${symbol} over ${horizon_days} days with median, 80% and 95% bands`}\r\n      />\r\n    </div>\r\n  );\r\n}\r\n"],"names":["ChartJS","LineController","LineElement","PointElement","LinearScale","CategoryScale","Tooltip","Filler","GOLD_GLOW","BAND80","BAND95","FanChart","data","artifact","a","jsx","symbol","horizon_days","median_path","bands","labels","i","yMedian","v","y80Low","y80High","y95Low","y95High","hoverIdx","setHoverIdx","React","hoverBand","setHoverBand","chartRef","clamp","lo","hi","chartData","GOLD","options","e","_els","chart","scales","x","y","pos","getRelativePosition","xVal","yVal","idx","y80L","y80H","y95L","y95H","band","canvas","hoverPlugin","ctx","chartArea","xPix","tag","pad","textX","textY","w","c","_a","onLeave","Line"],"mappings":"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"}