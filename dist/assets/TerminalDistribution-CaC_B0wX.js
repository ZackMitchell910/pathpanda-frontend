import{r as p,C as I,j as D}from"./index-BWcUjsGU.js";const L={p95:"rgba(59,130,246,0.08)",p80:"rgba(59,130,246,0.12)",p50:"rgba(250,204,21,0.18)"},T="#FACC15",W="#38BDF8",_="rgba(255,255,255,0.25)",$="rgba(255,255,255,0.38)";function K({prices:g,density:e,scenarioMeta:v,spot:f}){var n;const A=p.useRef(null),m=p.useRef(null),[y,h]=p.useState(!1),F=p.useRef(!1),x=p.useMemo(()=>{var r,l;return B(g,v,((l=(r=e==null?void 0:e.histogram)==null?void 0:r.bins)==null?void 0:l.length)??30)},[g,v,e]),R=p.useMemo(()=>{var i,a,d,k;const r=Array.isArray((i=e==null?void 0:e.kde)==null?void 0:i.x)?(a=e==null?void 0:e.kde)==null?void 0:a.x:[],l=Array.isArray((d=e==null?void 0:e.kde)==null?void 0:d.y)?(k=e==null?void 0:e.kde)==null?void 0:k.y:[];return!r||!l||r.length!==l.length||r.length===0?[]:r.map((P,o)=>{const t=Number(l[o]);return{x:Number.isFinite(P)?Number(P):0,y:Number.isFinite(t)?t:0}})},[e]),s=p.useMemo(()=>{const r=e==null?void 0:e.market;if(!r)return null;const l=Array.isArray(r==null?void 0:r.x)?r.x:Array.isArray(r==null?void 0:r.points)?r.points.map(a=>a==null?void 0:a[0]):[],i=Array.isArray(r==null?void 0:r.y)?r.y:Array.isArray(r==null?void 0:r.points)?r.points.map(a=>a==null?void 0:a[1]):[];return!(l!=null&&l.length)||l.length!==i.length?null:{label:typeof(r==null?void 0:r.label)=="string"?r.label:"Market-implied",points:l.map((a,d)=>({x:Number.isFinite(a)?Number(a):0,y:Number.isFinite(i[d])?Number(i[d]):0}))}},[e]),w=p.useMemo(()=>{if(!(e!=null&&e.hpd))return[];const r=[];return["p95","p80","p50"].forEach(l=>{var a;const i=(a=e.hpd)==null?void 0:a[l];Array.isArray(i)&&i.length>=2&&typeof i[0]=="number"&&typeof i[1]=="number"&&r.push({key:l,range:[i[0],i[1]],color:L[l]??"rgba(255,255,255,0.08)"})}),r},[e]),c=p.useMemo(()=>typeof(e==null?void 0:e.mode)=="number"&&Number.isFinite(e.mode)?e.mode:typeof(e==null?void 0:e.median)=="number"&&Number.isFinite(e.median)?e.median:null,[e]);return p.useEffect(()=>{var l;const r=!!((l=s==null?void 0:s.points)!=null&&l.length);r&&!F.current&&(F.current=!0,h(!0)),!r&&F.current&&(F.current=!1,h(!1))},[s]),p.useEffect(()=>{var k,P;const r=(k=A.current)==null?void 0:k.getContext("2d");if(!r)return;m.current&&(m.current.destroy(),m.current=null);const l={id:"terminalDensityOverlay",beforeDatasetsDraw(o){const{ctx:t,chartArea:u}=o,b=o.scales.x;w.length&&(t.save(),w.forEach(({range:E,color:N})=>{const C=b.getPixelForValue(E[0]),O=b.getPixelForValue(E[1]);t.fillStyle=N,t.fillRect(C,u.top,O-C,u.bottom-u.top)}),t.restore())},afterDatasetsDraw(o){var E;const{ctx:t,chartArea:u}=o,b=o.scales.x;if(c!==null){const N=b.getPixelForValue(c);t.save(),t.strokeStyle=T,t.lineWidth=1.5,t.beginPath(),t.moveTo(N,u.top),t.lineTo(N,u.bottom),t.stroke(),t.fillStyle="#0A0A0A",t.beginPath(),t.arc(N,u.top+12,6,0,Math.PI*2),t.fill(),t.strokeStyle=T,t.lineWidth=2,t.beginPath(),t.arc(N,u.top+12,6,0,Math.PI*2),t.stroke();const C=typeof f=="number"&&Number.isFinite(f)&&f?(c/f-1)*100:null,O=`Mode $${c.toFixed(2)}${Number.isFinite(C??NaN)?` (${C.toFixed(1)}%)`:""}`;t.font="11px Inter, system-ui, sans-serif",t.textAlign="right",t.textBaseline="top",t.fillStyle="rgba(250,204,21,0.9)",t.fillText(O,N-8,u.top+2),t.restore()}y&&((E=s==null?void 0:s.points)!=null&&E.length)&&(t.save(),t.font="10px Inter, system-ui, sans-serif",t.textAlign="right",t.textBaseline="bottom",t.fillStyle="rgba(56,189,248,0.85)",t.fillText(s.label,u.right-4,u.top+4),t.restore())}},i=[];x.scenarios.length?x.scenarios.forEach(o=>{i.push({label:o.label,data:x.bins.map(t=>({x:t.mid,y:t.scenarioTotals.get(o.id)??0})),backgroundColor:o.color,borderColor:o.color,borderWidth:0,stack:"scenarios",parsing:!1,barPercentage:1,categoryPercentage:1})}):i.push({label:"Histogram",data:x.bins.map(o=>({x:o.mid,y:o.total})),backgroundColor:_,borderColor:$,borderWidth:1,parsing:!1,barPercentage:1,categoryPercentage:1}),R.length&&i.push({type:"line",label:"Posterior density",data:R,borderColor:T,borderWidth:1.5,pointRadius:0,fill:!1,tension:.35,yAxisID:"density",parsing:!1}),y&&((P=s==null?void 0:s.points)!=null&&P.length)&&i.push({type:"line",label:s.label,data:s.points,borderColor:W,borderWidth:1,borderDash:[4,3],pointRadius:0,fill:!1,tension:.3,yAxisID:"density",parsing:!1});const a={responsive:!0,maintainAspectRatio:!1,animation:!1,scales:{x:{type:"linear",grid:{color:"rgba(255,255,255,0.08)"},ticks:{color:"rgba(255,255,255,0.6)",maxTicksLimit:8,callback(o){return typeof o=="number"?o.toFixed(0):o}}},y:{beginAtZero:!0,position:"left",grid:{color:"rgba(255,255,255,0.08)"},ticks:{color:"rgba(255,255,255,0.6)"},stacked:!!x.scenarios.length},density:{beginAtZero:!0,position:"right",grid:{drawOnChartArea:!1},ticks:{color:"rgba(255,255,255,0.4)",callback(o){return typeof o=="number"?o.toFixed(2):o}}}},plugins:{legend:{display:x.scenarios.length>0||y||!!R.length},tooltip:{backgroundColor:"rgba(17,17,17,0.95)",titleColor:"#fff",bodyColor:"#e5e7eb",borderColor:"rgba(255,255,255,0.12)",borderWidth:1,callbacks:{title:o=>{var u,b;const t=((u=o==null?void 0:o[0])==null?void 0:u.dataIndex)??0;return((b=x.bins[t])==null?void 0:b.label)??""},label:o=>{var C;const t=o.dataset.label??"",u=typeof((C=o.parsed)==null?void 0:C.y)=="number"?o.parsed.y:null,b=o.raw,E=b&&typeof b=="object"&&typeof b.y=="number"?b.y:typeof b=="number"?b:null;return` ${t}: ${Number(u??E??0).toFixed(2)}`}}}}},d=new I(r,{type:"bar",data:{datasets:i},options:a,plugins:[l]});return m.current=d,()=>{d.destroy(),m.current=null}},[S(x,R,s,y,w,c,f)]),D.jsxs("div",{className:"flex h-full flex-col",children:[(n=s==null?void 0:s.points)!=null&&n.length?D.jsx("div",{className:"mb-2 flex justify-end text-xs text-white/60",children:D.jsxs("label",{className:"flex items-center gap-2",children:[D.jsx("input",{type:"checkbox",className:"h-3 w-3 rounded border-white/30 bg-black/60",checked:y,onChange:r=>h(r.target.checked)}),"Market implied"]})}):null,D.jsx("div",{className:"relative h-full",children:D.jsx("canvas",{ref:A,className:"h-full w-full"})})]})}function B(g,e,v=30){const f=Array.isArray(g)?g.map((c,n)=>({value:Number(c),meta:Array.isArray(e)?e[n]:void 0})).filter(c=>Number.isFinite(c.value)):[];if(!f.length)return{bins:[],scenarios:[],min:0,max:0};const A=Math.min(...f.map(c=>c.value)),m=Math.max(...f.map(c=>c.value)),y=m-A||1,h=Math.max(5,Math.min(120,v)),F=y/h,x=Array.from({length:h},(c,n)=>{const r=A+n*F,l=r+F,i=r+F/2;return{x0:r,x1:l,mid:i,label:`${j(r)} â€“ ${j(l)}`,total:0,scenarioTotals:new Map}}),R=["#38BDF8","#22C55E","#F97316","#F43F5E","#818CF8","#A855F7","#FBBF24","#34D399"],s=new Map,w=Array.isArray(e)&&e.length===g.length;return f.forEach(({value:c,meta:n})=>{const r=Math.max(0,Math.min(h-1,Math.floor((c-A)/F))),l=x[r],i=w&&typeof(n==null?void 0:n.weight)=="number"&&Number.isFinite(n.weight)?Number(n.weight):1;if(l.total+=i,w){const a=typeof(n==null?void 0:n.scenario_id)=="string"?n.scenario_id:typeof(n==null?void 0:n.label)=="string"?n.label:null;if(a){if(!s.has(a)){const k=typeof(n==null?void 0:n.color)=="string"&&n.color.trim()?n.color:R[s.size%R.length];s.set(a,{id:a,label:(n==null?void 0:n.label)??a,color:k})}const d=s.get(a);l.scenarioTotals.set(d.id,(l.scenarioTotals.get(d.id)??0)+i)}}}),{bins:x,scenarios:Array.from(s.values()),min:A,max:m}}function S(g,e,v,f,A,m,y){return JSON.stringify({bins:g.bins.map(h=>[h.mid,h.total,Array.from(h.scenarioTotals.entries())]),scenarios:g.scenarios,kde:e,market:f?v:null,hpd:A,mode:m,spot:y??null})}function j(g){return Number(g).toFixed(2)}export{K as default};
